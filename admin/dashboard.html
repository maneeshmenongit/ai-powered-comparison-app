<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hopwise Cost Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --sunset-red: #FF6B6B;
            --sunset-orange: #FF8E53;
            --sunset-gold: #FFA500;
            --sky-blue: #87CEEB;
            --dark: #1E1E2E;
            --dark-surface: #282838;
            --dark-border: #3E3E4E;
            --success: #4ADE80;
            --warning: #FBBF24;
            --danger: #EF4444;
            --text-muted: #9CA3AF;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--dark);
            color: #fff;
            min-height: 100vh;
            padding: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--dark-border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--sunset-red), var(--sunset-orange), var(--sunset-gold));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--sunset-red), var(--sunset-orange), var(--sunset-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle { font-size: 0.85rem; color: var(--text-muted); }

        .last-updated {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: right;
        }

        .last-updated span { color: var(--success); }

        .refresh-btn {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            color: var(--sky-blue);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
            margin-top: 0.5rem;
            transition: all 0.2s;
        }

        .refresh-btn:hover { background: var(--dark-border); }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: var(--dark-surface);
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid var(--dark-border);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .summary-card.total {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.15), rgba(255, 165, 0, 0.15));
            border-color: var(--sunset-orange);
        }

        .summary-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .summary-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.75rem;
            font-weight: 600;
        }

        .summary-value.green { color: var(--success); }
        .summary-value.yellow { color: var(--warning); }
        .summary-value.red { color: var(--danger); }

        .summary-sub { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem; }

        /* Alert Banner */
        .alert-banner {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(74, 222, 128, 0.05));
            border: 1px solid var(--success);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .alert-banner.warning {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(239, 68, 68, 0.1));
            border-color: var(--warning);
        }

        .alert-banner.critical {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.1));
            border-color: var(--danger);
        }

        .alert-icon { font-size: 1.5rem; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: 600; font-size: 0.9rem; }
        .alert-desc { font-size: 0.75rem; color: var(--text-muted); }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 2rem 0 1rem;
        }

        .section-title { font-size: 1rem; font-weight: 600; color: var(--sky-blue); }

        /* Budget Cards */
        .budget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .budget-card {
            background: var(--dark-surface);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--dark-border);
        }

        .budget-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .budget-card-title { font-size: 0.85rem; font-weight: 600; }
        .budget-limit { font-size: 0.7rem; color: var(--text-muted); }

        .budget-amount {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .budget-progress { margin-top: 1rem; }

        .budget-progress-bar {
            width: 100%;
            height: 10px;
            background: var(--dark);
            border-radius: 5px;
            overflow: hidden;
        }

        .budget-progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .budget-progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* API Table */
        .api-table {
            background: var(--dark-surface);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--dark-border);
        }

        .table-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 2fr;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--dark-border);
            align-items: center;
        }

        .table-row.header {
            background: rgba(135, 206, 235, 0.1);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
        }

        .table-row:last-child { border-bottom: none; }

        .api-name { font-size: 0.85rem; font-weight: 600; }
        .api-tier { font-size: 0.65rem; color: var(--text-muted); text-transform: capitalize; }

        .cost-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--dark);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .progress-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            margin-top: 0.25rem;
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .status-badge.healthy { background: rgba(74, 222, 128, 0.15); color: var(--success); }
        .status-badge.warning { background: rgba(251, 191, 36, 0.15); color: var(--warning); }
        .status-badge.critical { background: rgba(239, 68, 68, 0.15); color: var(--danger); }

        /* Cost Log */
        .cost-log {
            background: var(--dark-surface);
            border-radius: 12px;
            border: 1px solid var(--dark-border);
            max-height: 350px;
            overflow-y: auto;
        }

        .log-entry {
            display: grid;
            grid-template-columns: 100px 180px 1fr 60px 90px;
            gap: 1rem;
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid var(--dark-border);
            font-size: 0.8rem;
            align-items: center;
        }

        .log-entry:last-child { border-bottom: none; }
        .log-entry:hover { background: rgba(135, 206, 235, 0.05); }

        .log-time {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .log-api {
            font-weight: 600;
            color: var(--sky-blue);
        }

        .log-endpoint {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
            font-size: 0.75rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .log-count {
            text-align: center;
            color: var(--warning);
            font-weight: 600;
        }

        .log-cost {
            font-family: 'JetBrains Mono', monospace;
            text-align: right;
            font-weight: 600;
            color: var(--success);
        }

        .log-details {
            grid-column: 2 / -1;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Static Costs */
        .static-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .static-card {
            background: var(--dark-surface);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--dark-border);
        }

        .static-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .static-name { font-size: 0.85rem; font-weight: 600; }
        .static-provider { font-size: 0.7rem; color: var(--text-muted); }
        .static-cost {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--success);
            margin-top: 0.5rem;
        }
        .static-freq { font-size: 0.65rem; color: var(--text-muted); }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--dark-border);
            border-top-color: var(--sky-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Footer */
        .footer {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--dark-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 1rem; }
            .table-row { grid-template-columns: 1fr 1fr; gap: 0.5rem; }
            .table-row.header { display: none; }
            .header { flex-direction: column; gap: 1rem; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <div class="logo-icon">üåç</div>
            <div>
                <div class="logo-text">Hopwise</div>
                <div class="subtitle">Cost Tracker Dashboard</div>
            </div>
        </div>
        <div class="last-updated">
            Last updated: <span id="lastUpdated">Loading...</span><br>
            <button class="refresh-btn" onclick="loadData()">‚Üª Refresh</button>
        </div>
    </div>

    <!-- Alert Banner -->
    <div class="alert-banner" id="alertBanner">
        <div class="alert-icon" id="alertIcon">‚è≥</div>
        <div class="alert-content">
            <div class="alert-title" id="alertTitle">Loading...</div>
            <div class="alert-desc" id="alertDesc">Fetching cost data from server</div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-grid">
        <div class="summary-card">
            <div class="summary-label">Google API (This Month)</div>
            <div class="summary-value green" id="monthlyGoogleCost">$0.00</div>
            <div class="summary-sub" id="monthlyRequests">0 requests</div>
        </div>
        <div class="summary-card">
            <div class="summary-label">Credit Remaining</div>
            <div class="summary-value green" id="creditRemaining">$200.00</div>
            <div class="summary-sub">of $200/month</div>
        </div>
        <div class="summary-card">
            <div class="summary-label">Static Costs</div>
            <div class="summary-value" id="staticCosts">$1.68</div>
            <div class="summary-sub">/month amortized</div>
        </div>
        <div class="summary-card total">
            <div class="summary-label">Total Monthly</div>
            <div class="summary-value green" id="totalMonthly">$0.00</div>
            <div class="summary-sub">net cost</div>
        </div>
    </div>

    <!-- Budget Overview -->
    <div class="section-header">
        <h2 class="section-title">üìä Budget Monitoring</h2>
    </div>
    <div class="budget-grid">
        <div class="budget-card">
            <div class="budget-card-header">
                <div>
                    <div class="budget-card-title">Google $200 Monthly Credit</div>
                    <div class="budget-limit">Resets 1st of each month</div>
                </div>
                <span class="status-badge healthy" id="creditStatus">‚óè Healthy</span>
            </div>
            <div class="budget-amount" id="creditUsed">$0.00 used</div>
            <div class="budget-progress">
                <div class="budget-progress-bar">
                    <div class="budget-progress-fill" id="creditBar" style="width: 0%; background: var(--success);"></div>
                </div>
                <div class="budget-progress-labels">
                    <span id="creditPct">0% used</span>
                    <span>$200 limit</span>
                </div>
            </div>
        </div>
        <div class="budget-card">
            <div class="budget-card-header">
                <div>
                    <div class="budget-card-title">Today's API Calls</div>
                    <div class="budget-limit" id="todayDate">-</div>
                </div>
            </div>
            <div class="budget-amount" id="todayCalls">0 calls</div>
            <div class="budget-progress">
                <div class="budget-amount" style="font-size: 1rem; color: var(--text-muted);" id="todayCost">$0.00 estimated</div>
            </div>
        </div>
    </div>

    <!-- API Usage Breakdown -->
    <div class="section-header">
        <h2 class="section-title">üîç API Usage Breakdown</h2>
    </div>
    <div class="api-table" id="apiTable">
        <div class="table-row header">
            <div>API Endpoint</div>
            <div>Calls</div>
            <div>Free Remaining</div>
            <div>Cost</div>
            <div>Usage</div>
        </div>
        <div class="loading" id="apiLoading">
            <div class="spinner"></div>
            Loading API data...
        </div>
    </div>

    <!-- Static Costs -->
    <div class="section-header">
        <h2 class="section-title">üí≥ Fixed Costs</h2>
    </div>
    <div class="static-grid" id="staticGrid">
        <div class="static-card">
            <div class="static-icon">üåê</div>
            <div class="static-name">hopwise.app</div>
            <div class="static-provider">Hostinger</div>
            <div class="static-cost">$15.99</div>
            <div class="static-freq">Annual</div>
        </div>
        <div class="static-card">
            <div class="static-icon">üìß</div>
            <div class="static-name"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5139343d3d3e11393e21263822347f302121">[email&#160;protected]</a></div>
            <div class="static-provider">Hostinger</div>
            <div class="static-cost">$4.20</div>
            <div class="static-freq">Annual</div>
        </div>
        <div class="static-card">
            <div class="static-icon">‚ö°</div>
            <div class="static-name">Netlify Hosting</div>
            <div class="static-provider">Free Tier</div>
            <div class="static-cost">$0.00</div>
            <div class="static-freq">Monthly</div>
        </div>
    </div>

    <!-- Cost Log -->
    <div class="section-header">
        <h2 class="section-title">üìÖ Recent API Calls</h2>
    </div>
    <div class="cost-log" id="costLog">
        <div class="loading" id="logLoading">
            <div class="spinner"></div>
            Loading recent calls...
        </div>
    </div>

    <div class="footer">
        <div>
            <strong>Hopwise Cost Tracker v2.0</strong><br>
            Connected to Flask Backend ‚Ä¢ Auto-refresh available
        </div>
        <div>
            API Endpoint: <code id="apiEndpoint">https://api.hopwise.app/api/costs</code>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ============================================
        // CONFIGURATION - Auto-detect Local vs Production
        // ============================================
        async function detectApiEndpoint() {
            // Try local backend first
            try {
                const response = await fetch('http://localhost:5001/api/costs/budget', {
                    method: 'GET',
                    signal: AbortSignal.timeout(2000) // 2 second timeout
                });
                if (response.ok) {
                    console.log('‚úì Connected to local backend');
                    return 'http://localhost:5001/api/costs';
                }
            } catch (e) {
                console.log('Local backend not available, using production');
            }
            // Fallback to production
            return 'https://api.hopwise.app/api/costs';
        }

        let API_BASE_URL = 'http://localhost:5001/api/costs'; // Will be updated by detectApiEndpoint()

        // ============================================
        // Data Loading Functions
        // ============================================
        
        async function loadData() {
            try {
                const response = await fetch(`${API_BASE_URL}/report`);
                if (!response.ok) throw new Error('Failed to fetch data');
                const data = await response.json();
                updateDashboard(data);
            } catch (error) {
                console.error('Error loading data:', error);
                showOfflineMode();
            }
        }

        function updateDashboard(data) {
            const { budget_status, monthly_dynamic_costs, static_costs, today } = data;

            // Update timestamp
            document.getElementById('lastUpdated').textContent = 
                new Date(data.generated_at).toLocaleString();

            // Update alert banner
            updateAlertBanner(budget_status);

            // Update summary cards
            document.getElementById('monthlyGoogleCost').textContent = 
                `$${monthly_dynamic_costs.gross_cost.toFixed(2)}`;
            document.getElementById('monthlyRequests').textContent = 
                `${monthly_dynamic_costs.total_requests.toLocaleString()} requests`;
            document.getElementById('creditRemaining').textContent = 
                `$${budget_status.credit_remaining.toFixed(2)}`;
            document.getElementById('staticCosts').textContent = 
                `$${static_costs.monthly_amortized.toFixed(2)}`;
            document.getElementById('totalMonthly').textContent = 
                `$${data.total_monthly_cost.toFixed(2)}`;

            // Update credit usage
            const creditPct = budget_status.credit_usage_pct;
            document.getElementById('creditUsed').textContent = 
                `$${monthly_dynamic_costs.gross_cost.toFixed(2)} used`;
            document.getElementById('creditPct').textContent = `${creditPct.toFixed(1)}% used`;
            
            const creditBar = document.getElementById('creditBar');
            creditBar.style.width = `${Math.min(creditPct, 100)}%`;
            creditBar.style.background = creditPct > 90 ? 'var(--danger)' : 
                                         creditPct > 70 ? 'var(--warning)' : 'var(--success)';

            // Update credit status badge
            const creditStatus = document.getElementById('creditStatus');
            creditStatus.className = `status-badge ${budget_status.overall_status}`;
            creditStatus.textContent = `‚óè ${budget_status.overall_status.charAt(0).toUpperCase() + budget_status.overall_status.slice(1)}`;

            // Update today's stats
            document.getElementById('todayDate').textContent = today.date;
            document.getElementById('todayCalls').textContent = `${today.total_calls} calls`;
            document.getElementById('todayCost').textContent = `$${today.total_cost.toFixed(4)} estimated`;

            // Update API table
            updateApiTable(monthly_dynamic_costs.by_api);

            // Update recent calls log
            loadRecentCalls();

            // Update color coding for summary values
            updateValueColors(budget_status, monthly_dynamic_costs);
        }

        function updateAlertBanner(budget_status) {
            const banner = document.getElementById('alertBanner');
            const icon = document.getElementById('alertIcon');
            const title = document.getElementById('alertTitle');
            const desc = document.getElementById('alertDesc');

            if (budget_status.overall_status === 'critical') {
                banner.className = 'alert-banner critical';
                icon.textContent = 'üö®';
                title.textContent = 'Critical: Approaching Credit Limit!';
                desc.textContent = `Usage at ${budget_status.credit_usage_pct.toFixed(1)}%. Consider optimizing API calls.`;
            } else if (budget_status.overall_status === 'warning') {
                banner.className = 'alert-banner warning';
                icon.textContent = '‚ö†Ô∏è';
                title.textContent = 'Warning: High API Usage';
                desc.textContent = `Usage at ${budget_status.credit_usage_pct.toFixed(1)}% of monthly credit. Monitor closely.`;
            } else {
                banner.className = 'alert-banner';
                icon.textContent = '‚úÖ';
                title.textContent = 'All Systems Healthy';
                desc.textContent = `Google API usage at ${budget_status.credit_usage_pct.toFixed(1)}% of $200 credit.`;
            }

            // Add API-specific alerts
            if (budget_status.api_alerts && budget_status.api_alerts.length > 0) {
                desc.textContent += ' | ' + budget_status.api_alerts.map(a => a.message).join(' | ');
            }
        }

        function updateApiTable(byApi) {
            const table = document.getElementById('apiTable');
            const loading = document.getElementById('apiLoading');
            
            // Remove loading indicator
            if (loading) loading.remove();

            // Clear existing rows (except header)
            const rows = table.querySelectorAll('.table-row:not(.header)');
            rows.forEach(row => row.remove());

            // Add rows for each API
            Object.entries(byApi).forEach(([apiName, data]) => {
                const usagePct = data.free_cap === Infinity ? 0 : 
                                 (data.total_calls / data.free_cap) * 100;
                const barColor = usagePct > 90 ? 'var(--danger)' : 
                                 usagePct > 70 ? 'var(--warning)' : 'var(--success)';

                const row = document.createElement('div');
                row.className = 'table-row';
                row.innerHTML = `
                    <div>
                        <div class="api-name">${formatApiName(apiName)}</div>
                        <div class="api-tier">${data.tier}</div>
                    </div>
                    <div class="cost-value">${data.total_calls.toLocaleString()}</div>
                    <div class="cost-value" style="color: ${data.free_remaining > 0 ? 'var(--success)' : 'var(--danger)'}">
                        ${data.free_cap === Infinity ? '‚àû' : data.free_remaining.toLocaleString()}
                    </div>
                    <div class="cost-value">$${data.cost.toFixed(4)}</div>
                    <div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(usagePct, 100)}%; background: ${barColor};"></div>
                        </div>
                        <div class="progress-text">${usagePct.toFixed(1)}% of free tier</div>
                    </div>
                `;
                table.appendChild(row);
            });

            // If no APIs, show empty state
            if (Object.keys(byApi).length === 0) {
                const emptyRow = document.createElement('div');
                emptyRow.className = 'table-row';
                emptyRow.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted);">No API calls recorded yet</div>`;
                table.appendChild(emptyRow);
            }
        }

        function formatApiName(name) {
            return name.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function updateValueColors(budget, monthly) {
            const monthlyValue = document.getElementById('monthlyGoogleCost');
            const creditValue = document.getElementById('creditRemaining');
            const totalValue = document.getElementById('totalMonthly');

            // Monthly cost color
            if (monthly.gross_cost > 150) {
                monthlyValue.className = 'summary-value red';
            } else if (monthly.gross_cost > 100) {
                monthlyValue.className = 'summary-value yellow';
            } else {
                monthlyValue.className = 'summary-value green';
            }

            // Credit remaining color
            if (budget.credit_remaining < 20) {
                creditValue.className = 'summary-value red';
            } else if (budget.credit_remaining < 60) {
                creditValue.className = 'summary-value yellow';
            } else {
                creditValue.className = 'summary-value green';
            }

            // Total monthly color
            if (monthly.net_cost > 0) {
                totalValue.className = 'summary-value yellow';
            } else {
                totalValue.className = 'summary-value green';
            }
        }

        async function loadRecentCalls() {
            try {
                const response = await fetch(`${API_BASE_URL}/recent?limit=10`);
                if (!response.ok) throw new Error('Failed to fetch recent calls');
                const calls = await response.json();
                updateCostLog(calls);
            } catch (error) {
                console.error('Error loading recent calls:', error);
                // Show error message in UI
                const logContainer = document.getElementById('costLog');
                const loading = document.getElementById('logLoading');
                if (loading) loading.remove();
                logContainer.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">‚ö†Ô∏è Unable to load recent calls</div>';
            }
        }

        function updateCostLog(calls) {
            const logContainer = document.getElementById('costLog');
            const loading = document.getElementById('logLoading');

            // Remove loading indicator
            if (loading) loading.remove();

            if (!calls || calls.length === 0) {
                logContainer.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">üì≠ 0 API calls found today</div>';
                return;
            }

            // Create log entries
            logContainer.innerHTML = calls.map(call => {
                const time = new Date(call.timestamp).toLocaleTimeString();
                const details = call.details ? JSON.stringify(call.details).substring(0, 100) : '';

                return `
                    <div class="log-entry">
                        <div class="log-time">${time}</div>
                        <div class="log-api">${call.api_type}</div>
                        <div class="log-endpoint">${call.endpoint}</div>
                        <div class="log-count">${call.request_count}x</div>
                        <div class="log-cost">$${call.estimated_cost.toFixed(4)}</div>
                        ${details ? `<div class="log-details">${details}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function showOfflineMode() {
            document.getElementById('alertBanner').className = 'alert-banner warning';
            document.getElementById('alertIcon').textContent = 'üì°';
            document.getElementById('alertTitle').textContent = 'Offline Mode';
            document.getElementById('alertDesc').textContent =
                `Cannot connect to ${API_BASE_URL}. Showing cached data or start the Flask server.`;

            const loading = document.getElementById('apiLoading');
            if (loading) {
                loading.innerHTML = `
                    <div style="text-align: center;">
                        <div style="color: var(--warning); margin-bottom: 0.5rem;">‚ö†Ô∏è Server Offline</div>
                        <div>Start your Flask server:</div>
                        <code style="display: block; margin-top: 0.5rem; padding: 0.5rem; background: var(--dark); border-radius: 4px;">
                            python app.py
                        </code>
                    </div>
                `;
            }
        }

        // ============================================
        // Page Initialization
        // ============================================
        async function init() {
            // Detect and set API endpoint
            API_BASE_URL = await detectApiEndpoint();
            document.getElementById('apiEndpoint').textContent = API_BASE_URL;

            // Load initial data
            await loadData();

            // Auto-refresh every 30 seconds
            setInterval(loadData, 30000);
        }

        // Start when page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>